<?xml version="1.0" encoding="UTF-8"?>
<project name="Kieker (quality)" basedir=".." xmlns:artifact="antlib:org.apache.maven.artifact.ant">

	<property file="build-config/build.properties" />
	
	<import file="compile-and-build.xml"/>
	
	<target name="static-analysis" depends="findbugs, pmd, checkstyle, cpd" description="Performs static analysis of Kieker's source and binary code employing FindBugs and PMD">
	</target>

	<target name="findbugs" depends="build-all,compile-tests" description="Performs a byte code analysis to find potential bugs employing findbugs">
		<taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask" classpath="${lib.fb.dir}/lib/findbugs-ant.jar" />
		<findbugs home="${lib.fb.dir}" reportLevel="low" effort="max" maxRank="20" excludeFilter="${quality.config.dir}/fb-filter.xml" output="xml" outputFile="${tmp.dir}/kieker-fb.xml">
			<auxClasspath>
				<fileset dir="${lib.dir}" includes="*.jar" />
				<fileset dir="${lib.dir}/disl-2.0/" includes="*.jar" />
				<fileset dir="${lib.dir}/sigar/" includes="*.jar" />
				<fileset dir="${lib.dir}/framework-libs/" includes="**/*.jar" />
				<fileset dir="${lib.cs.dir}/lib/" includes="checkstyle-all.jar" />
				<fileset dir="${example.javaee.jetty.lib.dir}">
					<include name="jetty-server-*.jar" />
					<include name="jetty-util-*.jar" />
					<include name="jetty-servlet-*.jar" />
				</fileset>	
			</auxClasspath>
			<sourcePath path="${src.dir}" />
			<sourcePath path="${test.dir}" />
			<class location="${build.dir}" />
		</findbugs>
	</target>
	
	<target name="cpd" depends="build-all,compile-tests" description="Performs a source code analysis to find duplicate code">
		<path id="pmd.libs">
			<fileset dir="${lib.pmd.dir}/lib">
				<include name="*.jar" />
			</fileset>
		</path>
		<taskdef name="cpd" classname="net.sourceforge.pmd.cpd.CPDTask" classpathref="pmd.libs" />
		<cpd minimumTokenCount="100" format="xml" outputFile="${tmp.dir}/cpd_report.xml">
			<fileset dir="${src.dir}" includes="**/*.java" />
			<fileset dir="${test.dir}" includes="**/*.java" />
		</cpd>
		<echo message="CPD report written to '${tmp.dir}/cpd_report.xml'" />
	</target>


	<target name="pmd" depends="build-all,compile-tests" description="Performs a source code analysis employing PMD">
		<path id="pmd.libs">
			<fileset dir="${lib.pmd.dir}/lib">
				<include name="*.jar" />
			</fileset>
		</path>
		<taskdef name="pmd" classname="net.sourceforge.pmd.ant.PMDTask" classpathref="pmd.libs" />
		<pmd shortFilenames="true" rulesetfiles="${quality.config.dir}/pmdrules.xml">
			<sourcelanguage name="java" version="1.6" />
			<formatter type="xml" toFile="${tmp.dir}/pmd_report.xml" />
			<fileset dir="${src.dir}" includes="**/*.java" />
			<fileset dir="${test.dir}" includes="**/*.java" />
		</pmd>
		<echo message="PMD report written to '${tmp.dir}/pmd_report.xml'" />
	</target>

	<target name="checkstyle" depends="build-all,compile-tests" description="Uses Checkstyle to find potential problems">
		<!-- We have to add the test directory from the build to the classpath as it contains some checkstyle checks. Checkstyle has to know these classes. As the
				 checks need some classes from the analysis and the common part, we have to add those build directories as well. -->
		<taskdef resource="checkstyletask.properties" classpath="${lib.cs.dir}/lib/checkstyle-all.jar;${build.tests.dir};${build.kieker.analysis.dir};${build.kieker.common.dir}" />
		<checkstyle config="${quality.config.dir}/cs-conf.xml" failOnViolation="false">
			<classpath>
				<fileset dir="${lib.dir}" includes="*.jar" />
				<fileset dir="${lib.dir}/framework-libs/" includes="**/*.jar" />
				<fileset dir="${dist.dir}" includes="${dist.kieker.main.jar}" />
			</classpath>
			<fileset dir="${src.dir}" includes="**/*.java" />
			<fileset dir="${test.dir}" includes="**/*.java" />
			<formatter type="xml" toFile="${tmp.dir}/cs_report.xml" />
			<property key="checkstyle.ignoreCustomKieker" value="error" />
		</checkstyle>
		<echo message="Checkstyle report written to '${tmp.dir}/cs_report.xml'" />
	</target>

</project>